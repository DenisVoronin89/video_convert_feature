2025-04-08 17:34:25,287 - INFO - Запуск подписки на канал Redis для получения задач
2025-04-08 17:34:25,295 - INFO - Redis доступен.
2025-04-08 17:34:25,295 - INFO - Проверка соединения с AWS S3...
2025-04-08 17:34:25,777 - INFO - Запуск приложения и инициализация базы данных...
2025-04-08 17:34:25,777 - DEBUG - Начало инициализации базы данных...
2025-04-08 17:34:25,836 - INFO - База данных успешно инициализирована.
2025-04-08 17:34:25,836 - INFO - Приложение успешно запущено. Соединение с базой данных установлено.
2025-04-08 17:34:25,836 - INFO - Директория уже существует: ./video_temp
2025-04-08 17:34:25,836 - INFO - Директория уже существует: ./image_temp
2025-04-08 17:34:25,836 - INFO - Директория уже существует: ./output_video
2025-04-08 17:34:25,836 - INFO - Директория уже существует: ./output_preview
2025-04-08 17:34:25,836 - INFO - Директория уже существует: ./user_logo
2025-04-08 17:34:25,836 - INFO - Директория уже существует: ./user_video_posters
2025-04-08 17:34:25,838 - INFO - Задача fetch_and_cache_profiles добавлена в расписание (каждые 8 минут).
2025-04-08 17:34:25,838 - INFO - Задача sync_data_to_db добавлена в расписание (каждые 8 минут).
2025-04-08 17:34:25,838 - INFO - Задача очистки логов добавлена в расписание (каждые 5 минут).
2025-04-08 17:34:25,839 - INFO - Задача очистки временных файлов добавлена в расписание (каждый день в 00:00).
2025-04-08 17:34:25,839 - INFO - Планировщик задач успешно запущен.
2025-04-08 17:34:26,258 - INFO - Соединение с AWS S3 установлено успешно.
2025-04-08 17:34:26,258 - INFO - Соединение с AWS S3 установлено успешно.
2025-04-08 17:34:26,259 - INFO - Подключаемся к Redis...
2025-04-08 17:34:26,259 - INFO - Подписались на канал video_tasks
2025-04-08 17:34:50,800 - INFO - Открытие сессии с БД...
2025-04-08 17:34:50,803 - INFO - Сессия с БД успешно открыта.
2025-04-08 17:34:50,948 - INFO - Поиск пользователя в базе данных.
2025-04-08 17:34:51,062 - INFO - Пользователь найден с ID 5
2025-04-08 17:34:51,191 - INFO - Получение избранного через get_favorites_from_cache.
2025-04-08 17:34:51,192 - INFO - Попытка получить избранное из кэша Redis для пользователя 5.
2025-04-08 17:34:51,201 - INFO - Избранное не найдено в кэше для пользователя 5. Загружаем из базы данных.
2025-04-08 17:34:51,201 - INFO - Открытие сессии с БД...
2025-04-08 17:34:51,201 - INFO - Сессия с БД успешно открыта.
2025-04-08 17:34:51,255 - INFO - У пользователя 5 нет избранных профилей.
2025-04-08 17:34:51,255 - INFO - Закрытие сессии с БД.
2025-04-08 17:34:51,256 - INFO - Избранное получено: []
2025-04-08 17:34:51,256 - INFO - Генерация токенов для пользователя.
2025-04-08 17:34:51,258 - INFO - Токены успешно сгенерированы.
2025-04-08 17:34:51,258 - INFO - Закрытие сессии с БД.
2025-04-08 17:35:59,401 - INFO - Получен запрос на загрузку изображения от пользователя с ID: 5
2025-04-08 17:35:59,409 - INFO - Изображение сохранено во временной директории: ./image_temp/a3ecc894-ccc9-4c74-86c6-6a673ef011eb_c66f50f4ecb6aaf160ae3bd590effe68.jpg (Размер: 0.07 MB)
2025-04-08 17:35:59,409 - INFO - Изображение успешно загружено: ./image_temp/a3ecc894-ccc9-4c74-86c6-6a673ef011eb_c66f50f4ecb6aaf160ae3bd590effe68.jpg
2025-04-08 17:36:45,070 - INFO - Получен запрос на загрузку видео от пользователя с ID: {current_user.user_id}
2025-04-08 17:36:45,121 - INFO - видео сохранено во временной директории: ./video_temp/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.mp4 (Размер: 3.20 MB)
2025-04-08 17:36:45,121 - INFO - Видео успешно загружено: ./video_temp/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.mp4
2025-04-08 17:37:25,861 - INFO - Открытие сессии с БД...
2025-04-08 17:37:25,863 - INFO - Сессия с БД успешно открыта.
2025-04-08 17:37:25,869 - INFO - Закрытие сессии с БД.
2025-04-08 17:37:25,869 - INFO - Данные о избранном и счетчике подписчиков успешно синхронизированы из кеша в базу данных для всех пользователей.
2025-04-08 17:37:40,543 - INFO - Получены данные профиля: {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#Diving', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'language': None}
2025-04-08 17:37:40,545 - INFO - Получены данные о изображении: {'image_path': './image_temp/a3ecc894-ccc9-4c74-86c6-6a673ef011eb_c66f50f4ecb6aaf160ae3bd590effe68.jpg'}
2025-04-08 17:37:40,545 - INFO - Получены данные о видео: {'video_path': './video_temp/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.mp4'}
2025-04-08 17:37:40,545 - INFO - Путь к изображению: ./image_temp/a3ecc894-ccc9-4c74-86c6-6a673ef011eb_c66f50f4ecb6aaf160ae3bd590effe68.jpg
2025-04-08 17:37:40,545 - INFO - Путь к видео: ./video_temp/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.mp4
2025-04-08 17:37:40,545 - INFO - Абсолютный путь к видео: /app/video_temp/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.mp4
2025-04-08 17:37:40,546 - INFO - Абсолютный путь к изображению: /app/image_temp/a3ecc894-ccc9-4c74-86c6-6a673ef011eb_c66f50f4ecb6aaf160ae3bd590effe68.jpg
2025-04-08 17:37:40,549 - INFO - Изображение перемещено в директорию user_logo: ./user_logo/83d4f206-b975-41a6-830d-48e8245e5a2a_a3ecc894-ccc9-4c74-86c6-6a673ef011eb_c66f50f4ecb6aaf160ae3bd590effe68.jpg (Размер: 0.07 MB)
2025-04-08 17:37:40,549 - INFO - Путь к файлу для сохранения в БД: ./user_logo/83d4f206-b975-41a6-830d-48e8245e5a2a_a3ecc894-ccc9-4c74-86c6-6a673ef011eb_c66f50f4ecb6aaf160ae3bd590effe68.jpg
2025-04-08 17:37:40,549 - INFO - Изображение успешно перемещено в постоянную папку: ./user_logo/83d4f206-b975-41a6-830d-48e8245e5a2a_a3ecc894-ccc9-4c74-86c6-6a673ef011eb_c66f50f4ecb6aaf160ae3bd590effe68.jpg
2025-04-08 17:37:40,549 - INFO - Обработка данных профиля...
2025-04-08 17:37:40,549 - INFO - Соединение с Redis для публикации задачи в канал установлено.
2025-04-08 17:37:40,549 - INFO - Публикуемые данные в Redis: {input_path: /app/video_temp/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.mp4, output_path: {'path': './output_video', 'status': 'exists'}, preview_path: {'path': './output_preview', 'status': 'exists'}, user_logo_url: /user_logo/83d4f206-b975-41a6-830d-48e8245e5a2a_a3ecc894-ccc9-4c74-86c6-6a673ef011eb_c66f50f4ecb6aaf160ae3bd590effe68.jpg, wallet_number: 0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545, form_data: {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#Diving', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'language': None}}
2025-04-08 17:37:40,568 - INFO - Задача успешно отправлена в канал video_tasks: {'input_path': '/app/video_temp/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.mp4', 'output_path': {'path': './output_video', 'status': 'exists'}, 'preview_path': {'path': './output_preview', 'status': 'exists'}, 'form_data': {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#Diving', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'language': None}, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'user_logo_url': '/user_logo/83d4f206-b975-41a6-830d-48e8245e5a2a_a3ecc894-ccc9-4c74-86c6-6a673ef011eb_c66f50f4ecb6aaf160ae3bd590effe68.jpg'}
2025-04-08 17:37:40,570 - INFO - Задача успешно отправлена в Redis.
2025-04-08 17:37:40,574 - INFO - Получено сообщение от Redis: {'type': 'message', 'pattern': None, 'channel': 'video_tasks', 'data': '{"input_path": "/app/video_temp/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.mp4", "output_path": {"path": "./output_video", "status": "exists"}, "preview_path": {"path": "./output_preview", "status": "exists"}, "form_data": {"name": "\\u041a\\u0443\\u0441\\u043e\\u043a \\u0441\\u0441\\u0430\\u043d\\u0438\\u043d\\u044b", "website_or_social": "https://twitter.com/johndoe", "activity_hobbies": "\\u0414\\u043e\\u043b\\u0431\\u0438\\u0442\\u044c\\u0441\\u044f \\u0432 \\u0441\\u0432\\u043e\\u0435 \\u043e\\u0447\\u043a\\u043e!", "hashtags": ["#gaming", "#Diving", "#travel", "#photography"], "adress": ["123 Example Street, Example City", "456 Another Street, Another City"], "city": "Example City", "coordinates": [[37.7749, -122.4194], [48.8566, 2.3522]], "is_in_mlm": 1, "is_incognito": false, "wallet_number": "0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545", "language": null}, "wallet_number": "0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545", "user_logo_url": "/user_logo/83d4f206-b975-41a6-830d-48e8245e5a2a_a3ecc894-ccc9-4c74-86c6-6a673ef011eb_c66f50f4ecb6aaf160ae3bd590effe68.jpg"}'}
2025-04-08 17:37:40,576 - INFO - Получена задача для обработки: {'input_path': '/app/video_temp/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.mp4', 'output_path': {'path': './output_video', 'status': 'exists'}, 'preview_path': {'path': './output_preview', 'status': 'exists'}, 'form_data': {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#Diving', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [[37.7749, -122.4194], [48.8566, 2.3522]], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'language': None}, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'user_logo_url': '/user_logo/83d4f206-b975-41a6-830d-48e8245e5a2a_a3ecc894-ccc9-4c74-86c6-6a673ef011eb_c66f50f4ecb6aaf160ae3bd590effe68.jpg'}
2025-04-08 17:37:40,576 - INFO - Конвертация видео: /app/video_temp/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.mp4
2025-04-08 17:37:40,578 - INFO - Начало конвертации: /app/video_temp/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.mp4 (размер: 3.20 MB)
2025-04-08 17:37:43,040 - INFO - Конвертация завершена за 2.46 сек | Размер: 2.62 MB | Коэффициент сжатия: 1.22x | Параметры: CRF=24, preset=fast
2025-04-08 17:37:43,040 - INFO - Видео сконвертировано: ./output_video/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.mp4
2025-04-08 17:37:43,040 - INFO - Генерация HLS плейлиста
2025-04-08 17:37:43,079 - INFO - HLS успешно сгенерирован: ./output_video/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat/hls/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.m3u8
2025-04-08 17:37:43,079 - INFO - HLS создан: ./output_video/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat/hls/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.m3u8
2025-04-08 17:37:43,079 - INFO - Извлечение постера из видео
2025-04-08 17:37:43,080 - INFO - Извлечение кадра из видео: ./output_video/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.mp4 -> user_video_posters/362bc401f4ad4c9fb6158647aa10d559.jpg (Время: 2 сек.)
2025-04-08 17:37:43,116 - INFO - Извлечение кадра завершено: user_video_posters/362bc401f4ad4c9fb6158647aa10d559.jpg (Время: 0.04 сек.)
2025-04-08 17:37:43,116 - INFO - Кадр успешно извлечён и сохранён: user_video_posters/362bc401f4ad4c9fb6158647aa10d559.jpg
2025-04-08 17:37:43,116 - INFO - Постер сохранен: user_video_posters/362bc401f4ad4c9fb6158647aa10d559.jpg
2025-04-08 17:37:43,116 - INFO - Загрузка файлов в S3
2025-04-08 17:37:43,845 - INFO - Соединение с AWS S3 установлено успешно.
2025-04-08 17:37:49,958 - INFO - Файлы загружены: https://stt-market-videos.s3.eu-north-1.amazonaws.com/videos/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat/4e11fce4-74c7-45aa-9835-734478eff4ff_cat_cat.mp4
2025-04-08 17:37:49,960 - INFO - Сохранение профиля в базе данных
2025-04-08 17:37:49,960 - INFO - Открытие сессии с БД...
2025-04-08 17:37:49,965 - INFO - Сессия с БД успешно открыта.
2025-04-08 17:37:50,150 - INFO - Начинаем удаление по префиксу: videos/0b180e88-2e93-46f9-9479-683a0197ec93_cat_cat/
2025-04-08 17:37:50,224 - INFO - Запрашиваем объекты для префикса: videos/0b180e88-2e93-46f9-9479-683a0197ec93_cat_cat/
2025-04-08 17:37:50,564 - INFO - Найдены объекты для удаления:
2025-04-08 17:37:50,948 - INFO - Успешно удалены:
2025-04-08 17:37:50,954 - INFO - Старые файлы удалены из облака для 0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545
2025-04-08 17:37:50,985 - DEBUG - Исходный путь логотип: /user_logo/6035945e-11a4-4c73-96de-75c6002238ad_67ca0126-5b65-4bbf-8d95-109c743eb32c_Снимок_экрана_2025-03-12_в_20.01.57.png
2025-04-08 17:37:50,990 - INFO - Файл логотип удалён с хоста: user_logo/6035945e-11a4-4c73-96de-75c6002238ad_67ca0126-5b65-4bbf-8d95-109c743eb32c_Снимок_экрана_2025-03-12_в_20.01.57.png
2025-04-08 17:37:50,993 - DEBUG - Исходный путь постер: user_video_posters/b9a8343a54064df5be3ba8420a915653.jpg
2025-04-08 17:37:50,995 - INFO - Файл постер удалён с хоста: user_video_posters/b9a8343a54064df5be3ba8420a915653.jpg
2025-04-08 17:37:50,996 - INFO - Профиль обновлен, уникальная ссылка сохранена: xvjy-01je-bkjd-3t93
2025-04-08 17:37:51,048 - INFO - Хэштеги синхронизированы. Оставлено: 4
2025-04-08 17:37:51,054 - INFO - Данные успешно сохранены для кошелька 0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545
2025-04-08 17:37:51,055 - INFO - Закрытие сессии с БД.
2025-04-08 17:37:51,055 - INFO - Профиль успешно сохранен
2025-04-08 17:37:51,055 - INFO - Задача завершена, данные очищены
2025-04-08 17:39:25,846 - INFO - Открытие сессии с БД...
2025-04-08 17:39:25,849 - INFO - Сессия с БД успешно открыта.
2025-04-08 17:39:25,964 - INFO - Логи старше 10 минут и строки с неправильным форматом удалены из файла video_service.log.
2025-04-08 17:39:26,004 - INFO - Успешно обработано и закэшировано 5 профилей в Redis.
2025-04-08 17:39:26,006 - INFO - Собрано уникальных профилей по алгоритму: 5
2025-04-08 17:39:26,006 - INFO - Сформировано страниц: 1
2025-04-08 17:39:26,006 - INFO - В кэше размещено 1 страниц.
2025-04-08 17:39:26,007 - INFO - Сформировано и закэшировано 1 страниц из 5 профилей.
2025-04-08 17:39:26,007 - INFO - Закрытие сессии с БД.
2025-04-08 17:39:43,715 - ERROR - Ошибка при получении сообщения: Connection closed by server.
Module: __main__, Function: main, Line: 170
