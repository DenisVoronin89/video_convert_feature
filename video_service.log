2025-03-19 15:19:59,349 - ERROR - Ошибка при получении сообщения: Connection closed by server.
Module: __main__, Function: main, Line: 181
2025-03-19 15:21:12,042 - INFO - Запуск приложения и инициализация базы данных...
2025-03-19 15:21:12,043 - DEBUG - Начало инициализации базы данных...
2025-03-19 15:21:12,209 - INFO - База данных успешно инициализирована.
2025-03-19 15:21:12,209 - INFO - Приложение успешно запущено. Соединение с базой данных установлено.
2025-03-19 15:21:12,210 - INFO - Директория уже существует: ./video_temp
2025-03-19 15:21:12,210 - INFO - Директория уже существует: ./image_temp
2025-03-19 15:21:12,210 - INFO - Директория уже существует: ./output_video
2025-03-19 15:21:12,210 - INFO - Директория уже существует: ./output_preview
2025-03-19 15:21:12,210 - INFO - Директория уже существует: ./user_logo
2025-03-19 15:21:12,210 - INFO - Директория уже существует: ./user_video_posters
2025-03-19 15:21:12,215 - INFO - Задача fetch_and_cache_profiles добавлена в расписание (каждые 8 минут).
2025-03-19 15:21:12,215 - INFO - Задача sync_data_to_db добавлена в расписание (каждые 8 минут).
2025-03-19 15:21:12,215 - INFO - Задача очистки временных файлов добавлена в расписание (каждый день в 00:00).
2025-03-19 15:21:12,216 - INFO - Планировщик задач успешно запущен.
2025-03-19 15:21:12,307 - INFO - Запуск подписки на канал Redis для получения задач
2025-03-19 15:21:12,314 - INFO - Redis доступен.
2025-03-19 15:21:12,314 - INFO - Проверка соединения с AWS S3...
2025-03-19 15:21:12,904 - INFO - Соединение с AWS S3 установлено успешно.
2025-03-19 15:21:12,904 - INFO - Соединение с AWS S3 установлено успешно.
2025-03-19 15:21:12,905 - INFO - Подключаемся к Redis...
2025-03-19 15:21:12,905 - INFO - Подписались на канал video_tasks
2025-03-19 15:21:33,371 - INFO - Открытие сессии с БД...
2025-03-19 15:21:33,381 - INFO - Сессия с БД успешно открыта.
2025-03-19 15:21:33,408 - INFO - Поиск пользователя в базе данных.
2025-03-19 15:21:33,476 - INFO - Пользователь найден с ID 2
2025-03-19 15:21:34,033 - INFO - Получение избранного через get_favorites_from_cache.
2025-03-19 15:21:34,033 - INFO - Попытка получить избранное из кэша Redis для пользователя 2.
2025-03-19 15:21:34,063 - INFO - Избранное не найдено в кэше для пользователя 2. Загружаем из базы данных.
2025-03-19 15:21:34,063 - INFO - Открытие сессии с БД...
2025-03-19 15:21:34,063 - INFO - Сессия с БД успешно открыта.
2025-03-19 15:21:34,211 - INFO - У пользователя 2 нет избранных профилей.
2025-03-19 15:21:34,211 - INFO - Закрытие сессии с БД.
2025-03-19 15:21:34,211 - INFO - Избранное получено: []
2025-03-19 15:21:34,211 - INFO - Генерация токенов для пользователя.
2025-03-19 15:21:34,212 - INFO - Токены успешно сгенерированы.
2025-03-19 15:21:34,212 - INFO - Закрытие сессии с БД.
2025-03-19 15:22:00,874 - INFO - Получен запрос на загрузку изображения от пользователя с ID: 2
2025-03-19 15:22:00,890 - INFO - Изображение сохранено во временной директории: ./image_temp/0dcf8730-9377-4511-8d02-e71d91f427aa_молекула_preview_rev_1.png (Размер: 0.09 MB)
2025-03-19 15:22:00,890 - INFO - Изображение успешно загружено: ./image_temp/0dcf8730-9377-4511-8d02-e71d91f427aa_молекула_preview_rev_1.png
2025-03-19 15:22:28,929 - INFO - Получен запрос на загрузку видео от пользователя с ID: {current_user.user_id}
2025-03-19 15:22:28,985 - INFO - видео сохранено во временной директории: ./video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4 (Размер: 4.03 MB)
2025-03-19 15:22:28,985 - INFO - Видео успешно загружено: ./video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4
2025-03-19 15:23:02,355 - INFO - Получены данные профиля: {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': ' ', 'language': None}
2025-03-19 15:23:02,358 - INFO - Получены данные о изображении: {'image_path': './image_temp/0dcf8730-9377-4511-8d02-e71d91f427aa_молекула_preview_rev_1.png'}
2025-03-19 15:23:02,358 - INFO - Получены данные о видео: {'video_path': './video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4'}
2025-03-19 15:23:02,358 - INFO - Путь к изображению: ./image_temp/0dcf8730-9377-4511-8d02-e71d91f427aa_молекула_preview_rev_1.png
2025-03-19 15:23:02,358 - INFO - Путь к видео: ./video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4
2025-03-19 15:23:02,358 - INFO - Абсолютный путь к видео: /app/video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4
2025-03-19 15:23:02,358 - INFO - Абсолютный путь к изображению: /app/image_temp/0dcf8730-9377-4511-8d02-e71d91f427aa_молекула_preview_rev_1.png
2025-03-19 15:23:02,390 - INFO - Изображение перемещено в директорию user_logo: ./user_logo/288fc412-fdcf-4705-bb1e-fe9f1b9030ba_0dcf8730-9377-4511-8d02-e71d91f427aa_молекула_preview_rev_1.png (Размер: 0.09 MB)
2025-03-19 15:23:02,390 - INFO - Путь к файлу для сохранения в БД: ./user_logo/288fc412-fdcf-4705-bb1e-fe9f1b9030ba_0dcf8730-9377-4511-8d02-e71d91f427aa_молекула_preview_rev_1.png
2025-03-19 15:23:02,390 - INFO - Изображение успешно перемещено в постоянную папку: ./user_logo/288fc412-fdcf-4705-bb1e-fe9f1b9030ba_0dcf8730-9377-4511-8d02-e71d91f427aa_молекула_preview_rev_1.png
2025-03-19 15:23:02,390 - INFO - Обработка данных профиля...
2025-03-19 15:23:02,390 - INFO - Соединение с Redis для публикации задачи в канал установлено.
2025-03-19 15:23:02,391 - INFO - Публикуемые данные в Redis: {input_path: /app/video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4, output_path: {'path': './output_video', 'status': 'exists'}, preview_path: {'path': './output_preview', 'status': 'exists'}, user_logo_url: /user_logo/288fc412-fdcf-4705-bb1e-fe9f1b9030ba_0dcf8730-9377-4511-8d02-e71d91f427aa_молекула_preview_rev_1.png, wallet_number:  , form_data: {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': ' ', 'language': None}}
2025-03-19 15:23:02,415 - INFO - Задача успешно отправлена в канал video_tasks: {'input_path': '/app/video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4', 'output_path': {'path': './output_video', 'status': 'exists'}, 'preview_path': {'path': './output_preview', 'status': 'exists'}, 'form_data': {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': ' ', 'language': None}, 'wallet_number': ' ', 'user_logo_url': '/user_logo/288fc412-fdcf-4705-bb1e-fe9f1b9030ba_0dcf8730-9377-4511-8d02-e71d91f427aa_молекула_preview_rev_1.png'}
2025-03-19 15:23:02,416 - INFO - Задача успешно отправлена в Redis.
2025-03-19 15:23:02,481 - INFO - Получено сообщение от Redis: {'type': 'message', 'pattern': None, 'channel': 'video_tasks', 'data': '{"input_path": "/app/video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4", "output_path": {"path": "./output_video", "status": "exists"}, "preview_path": {"path": "./output_preview", "status": "exists"}, "form_data": {"name": "\\u041a\\u0443\\u0441\\u043e\\u043a \\u0441\\u0441\\u0430\\u043d\\u0438\\u043d\\u044b", "website_or_social": "https://twitter.com/johndoe", "activity_hobbies": "\\u0414\\u043e\\u043b\\u0431\\u0438\\u0442\\u044c\\u0441\\u044f \\u0432 \\u0441\\u0432\\u043e\\u0435 \\u043e\\u0447\\u043a\\u043e!", "hashtags": ["#gaming", "#travel", "#photography"], "adress": ["123 Example Street, Example City", "456 Another Street, Another City"], "city": "Example City", "coordinates": [[37.7749, -122.4194], [48.8566, 2.3522]], "is_in_mlm": 1, "is_incognito": false, "wallet_number": " ", "language": null}, "wallet_number": " ", "user_logo_url": "/user_logo/288fc412-fdcf-4705-bb1e-fe9f1b9030ba_0dcf8730-9377-4511-8d02-e71d91f427aa_\\u043c\\u043e\\u043b\\u0435\\u043a\\u0443\\u043b\\u0430_preview_rev_1.png"}'}
2025-03-19 15:23:02,506 - INFO - Получена задача для обработки: {'input_path': '/app/video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4', 'output_path': {'path': './output_video', 'status': 'exists'}, 'preview_path': {'path': './output_preview', 'status': 'exists'}, 'form_data': {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [[37.7749, -122.4194], [48.8566, 2.3522]], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': ' ', 'language': None}, 'wallet_number': ' ', 'user_logo_url': '/user_logo/288fc412-fdcf-4705-bb1e-fe9f1b9030ba_0dcf8730-9377-4511-8d02-e71d91f427aa_молекула_preview_rev_1.png'}
2025-03-19 15:23:02,507 - INFO - Начинаю конвертацию видео /app/video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4 в VP9
2025-03-19 15:23:02,511 - INFO - Запуск конвертации видео в VP9: /app/video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4 -> ./48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_converted.webm
2025-03-19 15:23:21,687 - INFO - Конвертация в VP9 завершена: ./48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_converted.webm (Размер: 1.44 MB, Время: 19.18 сек.)
2025-03-19 15:23:21,689 - INFO - Видео успешно обработано: ./48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_converted.webm (Размер: 1.44 MB)
2025-03-19 15:23:21,690 - INFO - Путь к конвертированному видео: ./48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_converted.webm
2025-03-19 15:23:21,690 - INFO - Задача конвертации для /app/video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4 завершена успешно
2025-03-19 15:23:21,690 - INFO - Начинаю извлечение превью для /app/video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4
2025-03-19 15:23:21,690 - INFO - Извлечение превью из видео: /app/video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4 -> ./48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_preview.webm (Длительность: 5 сек.)
2025-03-19 15:23:28,949 - INFO - Извлечение превью завершено: ./48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_preview.webm (Размер: 0.54 MB, Время: 7.26 сек.)
2025-03-19 15:23:28,951 - INFO - Превью успешно извлечено: ./48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_preview.webm (Размер: 0.54 MB)
2025-03-19 15:23:28,951 - INFO - Путь к извлеченному превью: ./48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_preview.webm
2025-03-19 15:23:28,951 - INFO - Извлечение превью для /app/video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4 завершено успешно
2025-03-19 15:23:28,951 - INFO - Начинаю извлечение постера для /app/video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4
2025-03-19 15:23:28,954 - INFO - Извлечение кадра из видео: ./48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_preview.webm -> user_video_posters/5c82e45d0d754cca9885a455c77f7e44.jpg (Время: 2 сек.)
2025-03-19 15:23:29,064 - INFO - Извлечение кадра завершено: user_video_posters/5c82e45d0d754cca9885a455c77f7e44.jpg (Время: 0.11 сек.)
2025-03-19 15:23:29,064 - INFO - Кадр успешно извлечён и сохранён: user_video_posters/5c82e45d0d754cca9885a455c77f7e44.jpg
2025-03-19 15:23:29,064 - INFO - Извлечение постера для /app/video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4 завершено успешно. Путь: user_video_posters/5c82e45d0d754cca9885a455c77f7e44.jpg
2025-03-19 15:23:29,065 - INFO - Начинаю загрузку видео {'path': './output_video', 'status': 'exists'} и превью {'path': './output_preview', 'status': 'exists'} в S3
2025-03-19 15:23:29,702 - INFO - Соединение с AWS S3 установлено успешно.
2025-03-19 15:23:29,775 - INFO - Загрузка видео в AWS S3: ./48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_converted.webm -> 48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_converted.webm
2025-03-19 15:23:36,542 - INFO - Видео успешно загружено в AWS S3: 48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_converted.webm
2025-03-19 15:23:36,544 - INFO - Загрузка превью в AWS S3: ./48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_preview.webm -> 48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_preview.webm
2025-03-19 15:23:38,298 - INFO - Превью успешно загружено в AWS S3: 48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_preview.webm
2025-03-19 15:23:38,300 - INFO - Загруженные файлы: Видео - https://stt-market-videos.s3.eu-north-1.amazonaws.com/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_converted.webm, Превью - https://stt-market-videos.s3.eu-north-1.amazonaws.com/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_preview.webm
2025-03-19 15:23:38,302 - INFO - Загрузка видео {'path': './output_video', 'status': 'exists'} в S3 завершена успешно. URL: https://stt-market-videos.s3.eu-north-1.amazonaws.com/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_converted.webm
2025-03-19 15:23:38,302 - INFO - Загрузка превью {'path': './output_preview', 'status': 'exists'} в S3 завершена успешно. URL: https://stt-market-videos.s3.eu-north-1.amazonaws.com/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4_preview.webm
2025-03-19 15:23:38,303 - INFO - Начинаю сохранение профиля в БД для пользователя Кусок ссанины
2025-03-19 15:23:38,304 - INFO - Открытие сессии с БД...
2025-03-19 15:23:38,311 - INFO - Сессия с БД успешно открыта.
2025-03-19 15:23:38,488 - ERROR - Непредвиденная ошибка: 400: Пользователь с данным кошельком не найден.
Module: logging, Function: exception, Line: 1554
Traceback (most recent call last):
  File "/app/video_handle/video_handler_worker.py", line 270, in save_profile_to_db
    raise HTTPException(status_code=400, detail="Пользователь с данным кошельком не найден.")
fastapi.exceptions.HTTPException: 400: Пользователь с данным кошельком не найден.
2025-03-19 15:23:38,505 - ERROR - Ошибка в контексте сессии: 500: Ошибка сохранения данных в базе
Module: database, Function: get_db_session_for_worker, Line: 71
2025-03-19 15:23:38,505 - INFO - Закрытие сессии с БД.
2025-03-19 15:23:38,505 - ERROR - Ошибка при обработке задачи для видео /app/video_temp/48c831be-fac3-44db-9b6c-181201b50e24_100672-video-720.mp4: 500: Ошибка сохранения данных в базе
Module: __main__, Function: handle_task, Line: 111
2025-03-19 15:23:38,505 - INFO - Данные задачи очищены.
2025-03-19 15:23:38,505 - ERROR - Ошибка при получении сообщения: 500: Ошибка сохранения данных в базе
Module: __main__, Function: main, Line: 181
2025-03-19 15:24:12,256 - INFO - Открытие сессии с БД...
2025-03-19 15:24:12,264 - INFO - Сессия с БД успешно открыта.
2025-03-19 15:24:12,273 - INFO - Закрытие сессии с БД.
2025-03-19 15:24:12,274 - INFO - Данные о избранном и счетчике подписчиков успешно синхронизированы из кеша в базу данных для всех пользователей.
2025-03-19 15:26:12,229 - INFO - Открытие сессии с БД...
2025-03-19 15:26:12,231 - INFO - Сессия с БД успешно открыта.
2025-03-19 15:26:12,388 - INFO - Успешно обработано и закэшировано 1 профилей в Redis.
2025-03-19 15:26:12,388 - INFO - Собрано уникальных профилей по алгоритму: 1
2025-03-19 15:26:12,388 - INFO - Сформировано страниц: 1
2025-03-19 15:26:12,389 - INFO - В кэше размещено 1 страниц.
2025-03-19 15:26:12,389 - INFO - Сформировано и закэшировано 1 страниц из 1 профилей.
2025-03-19 15:26:12,389 - INFO - Закрытие сессии с БД.
2025-03-19 15:27:12,227 - INFO - Открытие сессии с БД...
2025-03-19 15:27:12,232 - INFO - Сессия с БД успешно открыта.
2025-03-19 15:27:12,252 - INFO - Закрытие сессии с БД.
2025-03-19 15:27:12,254 - INFO - Данные о избранном и счетчике подписчиков успешно синхронизированы из кеша в базу данных для всех пользователей.
2025-03-19 15:27:30,222 - INFO - Открытие сессии с БД...
2025-03-19 15:27:30,223 - INFO - Сессия с БД успешно открыта.
2025-03-19 15:27:30,230 - INFO - Поиск пользователя в базе данных.
2025-03-19 15:27:30,256 - INFO - Пользователь найден с ID 2
2025-03-19 15:27:30,261 - INFO - Получение избранного через get_favorites_from_cache.
2025-03-19 15:27:30,263 - INFO - Попытка получить избранное из кэша Redis для пользователя 2.
2025-03-19 15:27:30,275 - INFO - Избранное не найдено в кэше для пользователя 2. Загружаем из базы данных.
2025-03-19 15:27:30,275 - INFO - Открытие сессии с БД...
2025-03-19 15:27:30,276 - INFO - Сессия с БД успешно открыта.
2025-03-19 15:27:30,279 - INFO - У пользователя 2 нет избранных профилей.
2025-03-19 15:27:30,279 - INFO - Закрытие сессии с БД.
2025-03-19 15:27:30,284 - INFO - Избранное получено: []
2025-03-19 15:27:30,284 - INFO - Генерация токенов для пользователя.
2025-03-19 15:27:30,320 - INFO - Токены успешно сгенерированы.
2025-03-19 15:27:30,331 - INFO - Закрытие сессии с БД.
2025-03-19 15:28:19,332 - INFO - Получен запрос на загрузку изображения от пользователя с ID: 2
2025-03-19 15:28:19,341 - INFO - Изображение сохранено во временной директории: ./image_temp/978fa093-0646-49a4-a751-bbb277e7579e_молекула_preview_rev_1.png (Размер: 0.09 MB)
2025-03-19 15:28:19,341 - INFO - Изображение успешно загружено: ./image_temp/978fa093-0646-49a4-a751-bbb277e7579e_молекула_preview_rev_1.png
2025-03-19 15:28:47,801 - INFO - Получен запрос на загрузку видео от пользователя с ID: {current_user.user_id}
2025-03-19 15:28:47,820 - INFO - видео сохранено во временной директории: ./video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4 (Размер: 1.43 MB)
2025-03-19 15:28:47,820 - INFO - Видео успешно загружено: ./video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4
2025-03-19 15:29:49,278 - INFO - Получены данные профиля: {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x29b0B8cfa07fA65f36Ad653F679D36EBC7d4475', 'language': None}
2025-03-19 15:29:49,279 - INFO - Получены данные о изображении: {'image_path': './image_temp/978fa093-0646-49a4-a751-bbb277e7579e_молекула_preview_rev_1.png'}
2025-03-19 15:29:49,279 - INFO - Получены данные о видео: {'video_path': './video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4'}
2025-03-19 15:29:49,279 - INFO - Путь к изображению: ./image_temp/978fa093-0646-49a4-a751-bbb277e7579e_молекула_preview_rev_1.png
2025-03-19 15:29:49,279 - INFO - Путь к видео: ./video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4
2025-03-19 15:29:49,279 - INFO - Абсолютный путь к видео: /app/video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4
2025-03-19 15:29:49,280 - INFO - Абсолютный путь к изображению: /app/image_temp/978fa093-0646-49a4-a751-bbb277e7579e_молекула_preview_rev_1.png
2025-03-19 15:29:49,285 - INFO - Изображение перемещено в директорию user_logo: ./user_logo/4b3f0bda-d2bc-4f5d-b401-64aa246c5441_978fa093-0646-49a4-a751-bbb277e7579e_молекула_preview_rev_1.png (Размер: 0.09 MB)
2025-03-19 15:29:49,285 - INFO - Путь к файлу для сохранения в БД: ./user_logo/4b3f0bda-d2bc-4f5d-b401-64aa246c5441_978fa093-0646-49a4-a751-bbb277e7579e_молекула_preview_rev_1.png
2025-03-19 15:29:49,285 - INFO - Изображение успешно перемещено в постоянную папку: ./user_logo/4b3f0bda-d2bc-4f5d-b401-64aa246c5441_978fa093-0646-49a4-a751-bbb277e7579e_молекула_preview_rev_1.png
2025-03-19 15:29:49,285 - INFO - Обработка данных профиля...
2025-03-19 15:29:49,285 - INFO - Соединение с Redis для публикации задачи в канал установлено.
2025-03-19 15:29:49,286 - INFO - Публикуемые данные в Redis: {input_path: /app/video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4, output_path: {'path': './output_video', 'status': 'exists'}, preview_path: {'path': './output_preview', 'status': 'exists'}, user_logo_url: /user_logo/4b3f0bda-d2bc-4f5d-b401-64aa246c5441_978fa093-0646-49a4-a751-bbb277e7579e_молекула_preview_rev_1.png, wallet_number: 0x29b0B8cfa07fA65f36Ad653F679D36EBC7d4475, form_data: {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x29b0B8cfa07fA65f36Ad653F679D36EBC7d4475', 'language': None}}
2025-03-19 15:29:49,293 - INFO - Задача успешно отправлена в канал video_tasks: {'input_path': '/app/video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4', 'output_path': {'path': './output_video', 'status': 'exists'}, 'preview_path': {'path': './output_preview', 'status': 'exists'}, 'form_data': {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x29b0B8cfa07fA65f36Ad653F679D36EBC7d4475', 'language': None}, 'wallet_number': '0x29b0B8cfa07fA65f36Ad653F679D36EBC7d4475', 'user_logo_url': '/user_logo/4b3f0bda-d2bc-4f5d-b401-64aa246c5441_978fa093-0646-49a4-a751-bbb277e7579e_молекула_preview_rev_1.png'}
2025-03-19 15:29:49,293 - INFO - Задача успешно отправлена в Redis.
2025-03-19 15:29:49,301 - INFO - Получено сообщение от Redis: {'type': 'message', 'pattern': None, 'channel': 'video_tasks', 'data': '{"input_path": "/app/video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4", "output_path": {"path": "./output_video", "status": "exists"}, "preview_path": {"path": "./output_preview", "status": "exists"}, "form_data": {"name": "\\u041a\\u0443\\u0441\\u043e\\u043a \\u0441\\u0441\\u0430\\u043d\\u0438\\u043d\\u044b", "website_or_social": "https://twitter.com/johndoe", "activity_hobbies": "\\u0414\\u043e\\u043b\\u0431\\u0438\\u0442\\u044c\\u0441\\u044f \\u0432 \\u0441\\u0432\\u043e\\u0435 \\u043e\\u0447\\u043a\\u043e!", "hashtags": ["#gaming", "#travel", "#photography"], "adress": ["123 Example Street, Example City", "456 Another Street, Another City"], "city": "Example City", "coordinates": [[37.7749, -122.4194], [48.8566, 2.3522]], "is_in_mlm": 1, "is_incognito": false, "wallet_number": "0x29b0B8cfa07fA65f36Ad653F679D36EBC7d4475", "language": null}, "wallet_number": "0x29b0B8cfa07fA65f36Ad653F679D36EBC7d4475", "user_logo_url": "/user_logo/4b3f0bda-d2bc-4f5d-b401-64aa246c5441_978fa093-0646-49a4-a751-bbb277e7579e_\\u043c\\u043e\\u043b\\u0435\\u043a\\u0443\\u043b\\u0430_preview_rev_1.png"}'}
2025-03-19 15:29:49,306 - INFO - Получена задача для обработки: {'input_path': '/app/video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4', 'output_path': {'path': './output_video', 'status': 'exists'}, 'preview_path': {'path': './output_preview', 'status': 'exists'}, 'form_data': {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [[37.7749, -122.4194], [48.8566, 2.3522]], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x29b0B8cfa07fA65f36Ad653F679D36EBC7d4475', 'language': None}, 'wallet_number': '0x29b0B8cfa07fA65f36Ad653F679D36EBC7d4475', 'user_logo_url': '/user_logo/4b3f0bda-d2bc-4f5d-b401-64aa246c5441_978fa093-0646-49a4-a751-bbb277e7579e_молекула_preview_rev_1.png'}
2025-03-19 15:29:49,307 - INFO - Начинаю конвертацию видео /app/video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4 в VP9
2025-03-19 15:29:49,308 - INFO - Запуск конвертации видео в VP9: /app/video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4 -> ./27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_converted.webm
2025-03-19 15:29:55,402 - INFO - Конвертация в VP9 завершена: ./27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_converted.webm (Размер: 0.61 MB, Время: 6.09 сек.)
2025-03-19 15:29:55,403 - INFO - Видео успешно обработано: ./27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_converted.webm (Размер: 0.61 MB)
2025-03-19 15:29:55,403 - INFO - Путь к конвертированному видео: ./27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_converted.webm
2025-03-19 15:29:55,403 - INFO - Задача конвертации для /app/video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4 завершена успешно
2025-03-19 15:29:55,403 - INFO - Начинаю извлечение превью для /app/video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4
2025-03-19 15:29:55,403 - INFO - Извлечение превью из видео: /app/video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4 -> ./27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_preview.webm (Длительность: 5 сек.)
2025-03-19 15:30:02,755 - INFO - Извлечение превью завершено: ./27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_preview.webm (Размер: 0.52 MB, Время: 7.35 сек.)
2025-03-19 15:30:02,757 - INFO - Превью успешно извлечено: ./27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_preview.webm (Размер: 0.52 MB)
2025-03-19 15:30:02,757 - INFO - Путь к извлеченному превью: ./27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_preview.webm
2025-03-19 15:30:02,757 - INFO - Извлечение превью для /app/video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4 завершено успешно
2025-03-19 15:30:02,757 - INFO - Начинаю извлечение постера для /app/video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4
2025-03-19 15:30:02,758 - INFO - Извлечение кадра из видео: ./27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_preview.webm -> user_video_posters/b4d45240d51a449482b082aa4a3db179.jpg (Время: 2 сек.)
2025-03-19 15:30:02,857 - INFO - Извлечение кадра завершено: user_video_posters/b4d45240d51a449482b082aa4a3db179.jpg (Время: 0.10 сек.)
2025-03-19 15:30:02,858 - INFO - Кадр успешно извлечён и сохранён: user_video_posters/b4d45240d51a449482b082aa4a3db179.jpg
2025-03-19 15:30:02,858 - INFO - Извлечение постера для /app/video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4 завершено успешно. Путь: user_video_posters/b4d45240d51a449482b082aa4a3db179.jpg
2025-03-19 15:30:02,858 - INFO - Начинаю загрузку видео {'path': './output_video', 'status': 'exists'} и превью {'path': './output_preview', 'status': 'exists'} в S3
2025-03-19 15:30:03,394 - INFO - Соединение с AWS S3 установлено успешно.
2025-03-19 15:30:03,467 - INFO - Загрузка видео в AWS S3: ./27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_converted.webm -> 27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_converted.webm
2025-03-19 15:30:06,151 - INFO - Видео успешно загружено в AWS S3: 27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_converted.webm
2025-03-19 15:30:06,152 - INFO - Загрузка превью в AWS S3: ./27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_preview.webm -> 27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_preview.webm
2025-03-19 15:30:07,893 - INFO - Превью успешно загружено в AWS S3: 27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_preview.webm
2025-03-19 15:30:07,894 - INFO - Загруженные файлы: Видео - https://stt-market-videos.s3.eu-north-1.amazonaws.com/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_converted.webm, Превью - https://stt-market-videos.s3.eu-north-1.amazonaws.com/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_preview.webm
2025-03-19 15:30:07,895 - INFO - Загрузка видео {'path': './output_video', 'status': 'exists'} в S3 завершена успешно. URL: https://stt-market-videos.s3.eu-north-1.amazonaws.com/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_converted.webm
2025-03-19 15:30:07,895 - INFO - Загрузка превью {'path': './output_preview', 'status': 'exists'} в S3 завершена успешно. URL: https://stt-market-videos.s3.eu-north-1.amazonaws.com/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4_preview.webm
2025-03-19 15:30:07,896 - INFO - Начинаю сохранение профиля в БД для пользователя Кусок ссанины
2025-03-19 15:30:07,896 - INFO - Открытие сессии с БД...
2025-03-19 15:30:07,899 - INFO - Сессия с БД успешно открыта.
2025-03-19 15:30:08,026 - INFO - Хэштеги добавлены/обновлены для профиля пользователя 0x29b0B8cfa07fA65f36Ad653F679D36EBC7d4475
2025-03-19 15:30:08,031 - INFO - Видео, пользователь, логотип и хэштеги успешно сохранены для кошелька 0x29b0B8cfa07fA65f36Ad653F679D36EBC7d4475
2025-03-19 15:30:08,031 - INFO - Закрытие сессии с БД.
2025-03-19 15:30:08,032 - INFO - Профиль с именем Кусок ссанины успешно сохранен в БД
2025-03-19 15:30:08,032 - INFO - Весь цикл задач для /app/video_temp/27da1518-70a2-47dd-9061-090beccf0fa9_99878-video-720.mp4 выполнен успешно!
2025-03-19 15:30:08,032 - INFO - Данные задачи очищены.
2025-03-19 15:30:12,223 - INFO - Открытие сессии с БД...
2025-03-19 15:30:12,228 - INFO - Сессия с БД успешно открыта.
2025-03-19 15:30:12,235 - INFO - Закрытие сессии с БД.
2025-03-19 15:30:12,237 - INFO - Данные о избранном и счетчике подписчиков успешно синхронизированы из кеша в базу данных для всех пользователей.
2025-03-19 15:31:12,221 - INFO - Открытие сессии с БД...
2025-03-19 15:31:12,224 - INFO - Сессия с БД успешно открыта.
2025-03-19 15:31:12,289 - INFO - Успешно обработано и закэшировано 2 профилей в Redis.
2025-03-19 15:31:12,290 - INFO - Собрано уникальных профилей по алгоритму: 2
2025-03-19 15:31:12,290 - INFO - Сформировано страниц: 1
2025-03-19 15:31:12,291 - INFO - В кэше размещено 1 страниц.
2025-03-19 15:31:12,291 - INFO - Сформировано и закэшировано 1 страниц из 2 профилей.
2025-03-19 15:31:12,291 - INFO - Закрытие сессии с БД.
2025-03-19 15:32:16,716 - INFO - Открытие сессии с БД...
2025-03-19 15:32:16,721 - INFO - Сессия с БД успешно открыта.
2025-03-19 15:32:16,730 - INFO - Поиск пользователя в базе данных.
2025-03-19 15:32:16,746 - INFO - Пользователь найден с ID 2
2025-03-19 15:32:16,797 - INFO - Получение избранного через get_favorites_from_cache.
2025-03-19 15:32:16,797 - INFO - Попытка получить избранное из кэша Redis для пользователя 2.
2025-03-19 15:32:16,800 - INFO - Избранное не найдено в кэше для пользователя 2. Загружаем из базы данных.
2025-03-19 15:32:16,800 - INFO - Открытие сессии с БД...
2025-03-19 15:32:16,801 - INFO - Сессия с БД успешно открыта.
2025-03-19 15:32:16,808 - INFO - У пользователя 2 нет избранных профилей.
2025-03-19 15:32:16,808 - INFO - Закрытие сессии с БД.
2025-03-19 15:32:16,818 - INFO - Избранное получено: []
2025-03-19 15:32:16,818 - INFO - Генерация токенов для пользователя.
2025-03-19 15:32:16,824 - INFO - Токены успешно сгенерированы.
2025-03-19 15:32:16,829 - INFO - Закрытие сессии с БД.
2025-03-19 15:32:31,802 - ERROR - Ошибка при получении сообщения: Connection closed by server.
Module: __main__, Function: main, Line: 181
