2025-04-05 15:09:30,322 - INFO - Запуск подписки на канал Redis для получения задач
2025-04-05 15:09:30,344 - INFO - Redis доступен.
2025-04-05 15:09:30,344 - INFO - Проверка соединения с AWS S3...
2025-04-05 15:09:30,842 - INFO - Запуск приложения и инициализация базы данных...
2025-04-05 15:09:30,842 - DEBUG - Начало инициализации базы данных...
2025-04-05 15:09:30,920 - INFO - База данных успешно инициализирована.
2025-04-05 15:09:30,920 - INFO - Приложение успешно запущено. Соединение с базой данных установлено.
2025-04-05 15:09:30,920 - INFO - Директория уже существует: ./video_temp
2025-04-05 15:09:30,920 - INFO - Директория уже существует: ./image_temp
2025-04-05 15:09:30,921 - INFO - Директория уже существует: ./output_video
2025-04-05 15:09:30,921 - INFO - Директория уже существует: ./output_preview
2025-04-05 15:09:30,921 - INFO - Директория уже существует: ./user_logo
2025-04-05 15:09:30,921 - INFO - Директория уже существует: ./user_video_posters
2025-04-05 15:09:30,924 - INFO - Задача fetch_and_cache_profiles добавлена в расписание (каждые 8 минут).
2025-04-05 15:09:30,924 - INFO - Задача sync_data_to_db добавлена в расписание (каждые 8 минут).
2025-04-05 15:09:30,924 - INFO - Задача очистки логов добавлена в расписание (каждые 5 минут).
2025-04-05 15:09:30,924 - INFO - Задача очистки временных файлов добавлена в расписание (каждый день в 00:00).
2025-04-05 15:09:30,925 - INFO - Планировщик задач успешно запущен.
2025-04-05 15:09:31,121 - INFO - Соединение с AWS S3 установлено успешно.
2025-04-05 15:09:31,122 - INFO - Соединение с AWS S3 установлено успешно.
2025-04-05 15:09:31,122 - INFO - Подключаемся к Redis...
2025-04-05 15:09:31,122 - INFO - Подписались на канал video_tasks
2025-04-05 15:09:56,858 - INFO - Открытие сессии с БД...
2025-04-05 15:09:56,861 - INFO - Сессия с БД успешно открыта.
2025-04-05 15:09:56,882 - INFO - Поиск пользователя в базе данных.
2025-04-05 15:09:56,916 - INFO - Пользователь найден с ID 5
2025-04-05 15:09:57,020 - INFO - Получение избранного через get_favorites_from_cache.
2025-04-05 15:09:57,021 - INFO - Попытка получить избранное из кэша Redis для пользователя 5.
2025-04-05 15:09:57,026 - INFO - Избранное не найдено в кэше для пользователя 5. Загружаем из базы данных.
2025-04-05 15:09:57,026 - INFO - Открытие сессии с БД...
2025-04-05 15:09:57,026 - INFO - Сессия с БД успешно открыта.
2025-04-05 15:09:57,071 - INFO - У пользователя 5 нет избранных профилей.
2025-04-05 15:09:57,071 - INFO - Закрытие сессии с БД.
2025-04-05 15:09:57,072 - INFO - Избранное получено: []
2025-04-05 15:09:57,072 - INFO - Генерация токенов для пользователя.
2025-04-05 15:09:57,073 - INFO - Токены успешно сгенерированы.
2025-04-05 15:09:57,073 - INFO - Закрытие сессии с БД.
2025-04-05 15:10:29,714 - INFO - Получен запрос на загрузку видео от пользователя с ID: {current_user.user_id}
2025-04-05 15:10:29,841 - INFO - видео сохранено во временной директории: ./video_temp/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.mp4 (Размер: 9.35 MB)
2025-04-05 15:10:29,841 - INFO - Видео успешно загружено: ./video_temp/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.mp4
2025-04-05 15:12:30,934 - INFO - Открытие сессии с БД...
2025-04-05 15:12:30,941 - INFO - Сессия с БД успешно открыта.
2025-04-05 15:12:30,947 - INFO - Закрытие сессии с БД.
2025-04-05 15:12:30,947 - INFO - Данные о избранном и счетчике подписчиков успешно синхронизированы из кеша в базу данных для всех пользователей.
2025-04-05 15:13:11,944 - INFO - Получены данные профиля: {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'language': None}
2025-04-05 15:13:11,945 - INFO - Получены данные о изображении: {'image_path': '/user_logo/6be08dca-5609-4ca2-b608-a556bf4a2828_e059b312-d707-4d60-a3ec-29568afe292b_молекула_preview_rev_1.png'}
2025-04-05 15:13:11,945 - INFO - Получены данные о видео: {'video_path': './video_temp/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.mp4'}
2025-04-05 15:13:11,945 - INFO - Путь к изображению: /user_logo/6be08dca-5609-4ca2-b608-a556bf4a2828_e059b312-d707-4d60-a3ec-29568afe292b_молекула_preview_rev_1.png
2025-04-05 15:13:11,945 - INFO - Путь к видео: ./video_temp/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.mp4
2025-04-05 15:13:11,945 - INFO - Абсолютный путь к видео: /app/video_temp/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.mp4
2025-04-05 15:13:11,945 - INFO - Используется существующее изображение: /user_logo/6be08dca-5609-4ca2-b608-a556bf4a2828_e059b312-d707-4d60-a3ec-29568afe292b_молекула_preview_rev_1.png
2025-04-05 15:13:11,945 - INFO - Обработка данных профиля...
2025-04-05 15:13:11,946 - INFO - Соединение с Redis для публикации задачи в канал установлено.
2025-04-05 15:13:11,946 - INFO - Публикуемые данные в Redis: {input_path: /app/video_temp/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.mp4, output_path: {'path': './output_video', 'status': 'exists'}, preview_path: {'path': './output_preview', 'status': 'exists'}, user_logo_url: /user_logo/6be08dca-5609-4ca2-b608-a556bf4a2828_e059b312-d707-4d60-a3ec-29568afe292b_молекула_preview_rev_1.png, wallet_number: 0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545, form_data: {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'language': None}}
2025-04-05 15:13:11,951 - INFO - Задача успешно отправлена в канал video_tasks: {'input_path': '/app/video_temp/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.mp4', 'output_path': {'path': './output_video', 'status': 'exists'}, 'preview_path': {'path': './output_preview', 'status': 'exists'}, 'form_data': {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'language': None}, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'user_logo_url': '/user_logo/6be08dca-5609-4ca2-b608-a556bf4a2828_e059b312-d707-4d60-a3ec-29568afe292b_молекула_preview_rev_1.png'}
2025-04-05 15:13:11,951 - INFO - Задача успешно отправлена в Redis.
2025-04-05 15:13:11,959 - INFO - Получено сообщение от Redis: {'type': 'message', 'pattern': None, 'channel': 'video_tasks', 'data': '{"input_path": "/app/video_temp/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.mp4", "output_path": {"path": "./output_video", "status": "exists"}, "preview_path": {"path": "./output_preview", "status": "exists"}, "form_data": {"name": "\\u041a\\u0443\\u0441\\u043e\\u043a \\u0441\\u0441\\u0430\\u043d\\u0438\\u043d\\u044b", "website_or_social": "https://twitter.com/johndoe", "activity_hobbies": "\\u0414\\u043e\\u043b\\u0431\\u0438\\u0442\\u044c\\u0441\\u044f \\u0432 \\u0441\\u0432\\u043e\\u0435 \\u043e\\u0447\\u043a\\u043e!", "hashtags": ["#gaming", "#travel", "#photography"], "adress": ["123 Example Street, Example City", "456 Another Street, Another City"], "city": "Example City", "coordinates": [[37.7749, -122.4194], [48.8566, 2.3522]], "is_in_mlm": 1, "is_incognito": false, "wallet_number": "0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545", "language": null}, "wallet_number": "0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545", "user_logo_url": "/user_logo/6be08dca-5609-4ca2-b608-a556bf4a2828_e059b312-d707-4d60-a3ec-29568afe292b_\\u043c\\u043e\\u043b\\u0435\\u043a\\u0443\\u043b\\u0430_preview_rev_1.png"}'}
2025-04-05 15:13:11,964 - INFO - Получена задача для обработки: {'input_path': '/app/video_temp/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.mp4', 'output_path': {'path': './output_video', 'status': 'exists'}, 'preview_path': {'path': './output_preview', 'status': 'exists'}, 'form_data': {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [[37.7749, -122.4194], [48.8566, 2.3522]], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'language': None}, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'user_logo_url': '/user_logo/6be08dca-5609-4ca2-b608-a556bf4a2828_e059b312-d707-4d60-a3ec-29568afe292b_молекула_preview_rev_1.png'}
2025-04-05 15:13:11,964 - INFO - Конвертация видео: /app/video_temp/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.mp4
2025-04-05 15:13:11,968 - INFO - Начало конвертации: /app/video_temp/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.mp4 (размер: 9.35 MB)
2025-04-05 15:13:17,834 - INFO - Конвертация завершена за 5.87 сек | Размер: 2.64 MB | Коэффициент сжатия: 3.55x | Параметры: CRF=22, preset=fast
2025-04-05 15:13:17,835 - INFO - Видео сконвертировано: ./output_video/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.mp4
2025-04-05 15:13:17,835 - INFO - Генерация HLS плейлиста
2025-04-05 15:13:17,873 - INFO - HLS успешно сгенерирован: ./output_video/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720/hls/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.m3u8
2025-04-05 15:13:17,874 - INFO - HLS создан: ./output_video/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720/hls/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.m3u8
2025-04-05 15:13:17,874 - INFO - Извлечение постера из видео
2025-04-05 15:13:17,875 - INFO - Извлечение кадра из видео: ./output_video/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.mp4 -> user_video_posters/997d61efc40d49f48926ba7fbfd20f93.jpg (Время: 2 сек.)
2025-04-05 15:13:17,963 - INFO - Извлечение кадра завершено: user_video_posters/997d61efc40d49f48926ba7fbfd20f93.jpg (Время: 0.09 сек.)
2025-04-05 15:13:17,963 - INFO - Кадр успешно извлечён и сохранён: user_video_posters/997d61efc40d49f48926ba7fbfd20f93.jpg
2025-04-05 15:13:17,963 - INFO - Постер сохранен: user_video_posters/997d61efc40d49f48926ba7fbfd20f93.jpg
2025-04-05 15:13:17,963 - INFO - Загрузка файлов в S3
2025-04-05 15:13:18,635 - INFO - Соединение с AWS S3 установлено успешно.
2025-04-05 15:13:46,460 - INFO - Файлы загружены: https://stt-market-videos.s3.eu-north-1.amazonaws.com/videos/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720/0fcd97b3-155a-48e2-b48a-32c9804b95f0_100687-video-720.mp4
2025-04-05 15:13:46,462 - INFO - Сохранение профиля в базе данных
2025-04-05 15:13:46,462 - INFO - Открытие сессии с БД...
2025-04-05 15:13:46,465 - INFO - Сессия с БД успешно открыта.
2025-04-05 15:13:46,595 - INFO - Начинаем удаление по префиксу: videos/b2c72836-384f-4a1c-bf61-1633b8a56507_100687-video-720/
2025-04-05 15:13:46,642 - INFO - Запрашиваем объекты для префикса: videos/b2c72836-384f-4a1c-bf61-1633b8a56507_100687-video-720/
2025-04-05 15:13:47,112 - INFO - Найдены объекты для удаления:
2025-04-05 15:13:47,558 - INFO - Успешно удалены:
2025-04-05 15:13:47,559 - INFO - Старые файлы удалены из облака для 0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545
2025-04-05 15:13:47,575 - INFO - Локальный файл постера удален: user_video_posters/bb34e1cc51404c3b9753ba7e4f22eb8b.jpg
2025-04-05 15:13:47,575 - INFO - Профиль обновлен, уникальная ссылка сохранена: xvjy-01je-bkjd-3t93
2025-04-05 15:13:47,600 - INFO - Обновлено хэштегов: 3
2025-04-05 15:13:47,602 - INFO - Данные успешно сохранены для кошелька 0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545
2025-04-05 15:13:47,603 - INFO - Закрытие сессии с БД.
2025-04-05 15:13:47,603 - INFO - Профиль успешно сохранен
2025-04-05 15:13:47,603 - INFO - Задача завершена, данные очищены
2025-04-05 15:14:30,938 - INFO - Открытие сессии с БД...
2025-04-05 15:14:30,942 - INFO - Сессия с БД успешно открыта.
2025-04-05 15:14:30,999 - INFO - Логи старше 10 минут и строки с неправильным форматом удалены из файла video_service.log.
2025-04-05 15:14:31,032 - INFO - Успешно обработано и закэшировано 5 профилей в Redis.
2025-04-05 15:14:31,033 - INFO - Собрано уникальных профилей по алгоритму: 5
2025-04-05 15:14:31,033 - INFO - Сформировано страниц: 1
2025-04-05 15:14:31,033 - INFO - В кэше размещено 1 страниц.
2025-04-05 15:14:31,033 - INFO - Сформировано и закэшировано 1 страниц из 5 профилей.
2025-04-05 15:14:31,033 - INFO - Закрытие сессии с БД.
2025-04-05 15:14:31,167 - INFO - Открытие сессии с БД...
2025-04-05 15:14:31,167 - INFO - Сессия с БД успешно открыта.
2025-04-05 15:14:31,169 - INFO - Поиск пользователя в базе данных.
2025-04-05 15:14:31,171 - INFO - Пользователь найден с ID 5
2025-04-05 15:14:31,174 - INFO - Получение избранного через get_favorites_from_cache.
2025-04-05 15:14:31,174 - INFO - Попытка получить избранное из кэша Redis для пользователя 5.
2025-04-05 15:14:31,175 - INFO - Избранное не найдено в кэше для пользователя 5. Загружаем из базы данных.
2025-04-05 15:14:31,175 - INFO - Открытие сессии с БД...
2025-04-05 15:14:31,175 - INFO - Сессия с БД успешно открыта.
2025-04-05 15:14:31,176 - INFO - У пользователя 5 нет избранных профилей.
2025-04-05 15:14:31,176 - INFO - Закрытие сессии с БД.
2025-04-05 15:14:31,176 - INFO - Избранное получено: []
2025-04-05 15:14:31,177 - INFO - Генерация токенов для пользователя.
2025-04-05 15:14:31,178 - INFO - Токены успешно сгенерированы.
2025-04-05 15:14:31,178 - INFO - Закрытие сессии с БД.
2025-04-05 15:14:41,211 - ERROR - Ошибка при получении сообщения: Connection closed by server.
Module: __main__, Function: main, Line: 170
