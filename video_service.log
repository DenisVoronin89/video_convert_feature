2025-03-11 20:35:13,278 - INFO - Запуск подписки на канал Redis для получения задач
2025-03-11 20:35:13,289 - INFO - Redis доступен.
2025-03-11 20:35:13,289 - INFO - Проверка соединения с AWS S3...
2025-03-11 20:35:13,646 - INFO - Запуск приложения и инициализация базы данных...
2025-03-11 20:35:13,646 - DEBUG - Начало инициализации базы данных...
2025-03-11 20:35:13,703 - INFO - База данных успешно инициализирована.
2025-03-11 20:35:13,703 - INFO - Приложение успешно запущено. Соединение с базой данных установлено.
2025-03-11 20:35:13,704 - INFO - Директория уже существует: ./video_temp
2025-03-11 20:35:13,704 - INFO - Директория уже существует: ./image_temp
2025-03-11 20:35:13,704 - INFO - Директория уже существует: ./output_video
2025-03-11 20:35:13,704 - INFO - Директория уже существует: ./output_preview
2025-03-11 20:35:13,704 - INFO - Директория уже существует: ./user_logo
2025-03-11 20:35:13,706 - INFO - Задача fetch_and_cache_profiles добавлена в расписание (каждые 8 минут).
2025-03-11 20:35:13,706 - INFO - Задача sync_data_to_db добавлена в расписание (каждые 8 минут).
2025-03-11 20:35:13,707 - INFO - Задача очистки логов добавлена в расписание (каждые 5 минут).
2025-03-11 20:35:13,707 - INFO - Задача очистки временных файлов добавлена в расписание (каждый день в 00:00).
2025-03-11 20:35:13,707 - INFO - Планировщик задач успешно запущен.
2025-03-11 20:35:13,714 - INFO - Соединение с AWS S3 установлено успешно.
2025-03-11 20:35:13,714 - INFO - Соединение с AWS S3 установлено успешно.
2025-03-11 20:35:13,714 - INFO - Подключаемся к Redis...
2025-03-11 20:35:13,714 - INFO - Подписались на канал video_tasks
2025-03-11 20:35:46,870 - INFO - Открытие сессии с БД...
2025-03-11 20:35:46,883 - INFO - Сессия с БД успешно открыта.
2025-03-11 20:35:46,926 - INFO - Поиск пользователя в базе данных.
2025-03-11 20:35:47,057 - INFO - Пользователь найден с ID 941
2025-03-11 20:35:47,155 - INFO - Получение избранного через get_favorites_from_cache.
2025-03-11 20:35:47,155 - INFO - Попытка получить избранное из кэша Redis для пользователя 941.
2025-03-11 20:35:47,164 - INFO - Избранное не найдено в кэше для пользователя 941. Загружаем из базы данных.
2025-03-11 20:35:47,164 - INFO - Открытие сессии с БД...
2025-03-11 20:35:47,164 - INFO - Сессия с БД успешно открыта.
2025-03-11 20:35:47,203 - INFO - У пользователя 941 нет избранных профилей.
2025-03-11 20:35:47,203 - INFO - Закрытие сессии с БД.
2025-03-11 20:35:47,204 - INFO - Избранное получено: []
2025-03-11 20:35:47,204 - INFO - Генерация токенов для пользователя.
2025-03-11 20:35:47,205 - INFO - Токены успешно сгенерированы.
2025-03-11 20:35:47,206 - INFO - Закрытие сессии с БД.
2025-03-11 20:36:24,338 - INFO - Получен запрос на загрузку изображения от пользователя с ID: 941
2025-03-11 20:36:24,357 - INFO - Изображение сохранено во временной директории: ./image_temp/96375f13-7391-4dad-949d-420a0069ceb1_молекула_preview_rev_1.png (Размер: 0.09 MB)
2025-03-11 20:36:24,357 - INFO - Изображение успешно загружено: ./image_temp/96375f13-7391-4dad-949d-420a0069ceb1_молекула_preview_rev_1.png
2025-03-11 20:37:32,365 - INFO - Получен запрос на загрузку видео от пользователя с ID: {current_user.user_id}
2025-03-11 20:37:32,428 - INFO - видео сохранено во временной директории: ./video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4 (Размер: 4.65 MB)
2025-03-11 20:37:32,429 - INFO - Видео успешно загружено: ./video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4
2025-03-11 20:38:09,519 - INFO - Получены данные профиля: {'name': 'Кусок обоссонного гавна', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x27b0B8cfa07fA72f36Ad953F679D36EBC7d4355', 'language': None}
2025-03-11 20:38:09,520 - INFO - Получены данные о изображении: {'image_path': './image_temp/96375f13-7391-4dad-949d-420a0069ceb1_молекула_preview_rev_1.png'}
2025-03-11 20:38:09,520 - INFO - Получены данные о видео: {'video_path': './video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4'}
2025-03-11 20:38:09,520 - INFO - Путь к изображению: ./image_temp/96375f13-7391-4dad-949d-420a0069ceb1_молекула_preview_rev_1.png
2025-03-11 20:38:09,520 - INFO - Путь к видео: ./video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4
2025-03-11 20:38:09,520 - INFO - Абсолютный путь к видео: /app/video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4
2025-03-11 20:38:09,521 - INFO - Абсолютный путь к изображению: /app/image_temp/96375f13-7391-4dad-949d-420a0069ceb1_молекула_preview_rev_1.png
2025-03-11 20:38:09,525 - INFO - Изображение перемещено в директорию user_logo: ./user_logo/02adc6e0-3142-4d7b-b6b0-aca006ad7a43_96375f13-7391-4dad-949d-420a0069ceb1_молекула_preview_rev_1.png (Размер: 0.09 MB)
2025-03-11 20:38:09,525 - INFO - Путь к файлу для сохранения в БД: ./user_logo/02adc6e0-3142-4d7b-b6b0-aca006ad7a43_96375f13-7391-4dad-949d-420a0069ceb1_молекула_preview_rev_1.png
2025-03-11 20:38:09,525 - INFO - Изображение успешно перемещено в постоянную папку: ./user_logo/02adc6e0-3142-4d7b-b6b0-aca006ad7a43_96375f13-7391-4dad-949d-420a0069ceb1_молекула_preview_rev_1.png
2025-03-11 20:38:09,525 - INFO - Обработка данных профиля...
2025-03-11 20:38:09,525 - INFO - Соединение с Redis для публикации задачи в канал установлено.
2025-03-11 20:38:09,525 - INFO - Публикуемые данные в Redis: {input_path: /app/video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4, output_path: {'path': './output_video', 'status': 'exists'}, preview_path: {'path': './output_preview', 'status': 'exists'}, user_logo_url: /user_logo/02adc6e0-3142-4d7b-b6b0-aca006ad7a43_96375f13-7391-4dad-949d-420a0069ceb1_молекула_preview_rev_1.png, wallet_number: 0x27b0B8cfa07fA72f36Ad953F679D36EBC7d4355, form_data: {'name': 'Кусок обоссонного гавна', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x27b0B8cfa07fA72f36Ad953F679D36EBC7d4355', 'language': None}}
2025-03-11 20:38:09,537 - INFO - Задача успешно отправлена в канал video_tasks: {'input_path': '/app/video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4', 'output_path': {'path': './output_video', 'status': 'exists'}, 'preview_path': {'path': './output_preview', 'status': 'exists'}, 'form_data': {'name': 'Кусок обоссонного гавна', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x27b0B8cfa07fA72f36Ad953F679D36EBC7d4355', 'language': None}, 'wallet_number': '0x27b0B8cfa07fA72f36Ad953F679D36EBC7d4355', 'user_logo_url': '/user_logo/02adc6e0-3142-4d7b-b6b0-aca006ad7a43_96375f13-7391-4dad-949d-420a0069ceb1_молекула_preview_rev_1.png'}
2025-03-11 20:38:09,538 - INFO - Задача успешно отправлена в Redis.
2025-03-11 20:38:09,564 - INFO - Получено сообщение от Redis: {'type': 'message', 'pattern': None, 'channel': 'video_tasks', 'data': '{"input_path": "/app/video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4", "output_path": {"path": "./output_video", "status": "exists"}, "preview_path": {"path": "./output_preview", "status": "exists"}, "form_data": {"name": "\\u041a\\u0443\\u0441\\u043e\\u043a \\u043e\\u0431\\u043e\\u0441\\u0441\\u043e\\u043d\\u043d\\u043e\\u0433\\u043e \\u0433\\u0430\\u0432\\u043d\\u0430", "website_or_social": "https://twitter.com/johndoe", "activity_hobbies": "\\u0414\\u043e\\u043b\\u0431\\u0438\\u0442\\u044c\\u0441\\u044f \\u0432 \\u0441\\u0432\\u043e\\u0435 \\u043e\\u0447\\u043a\\u043e!", "hashtags": ["#gaming", "#travel", "#photography"], "adress": ["123 Example Street, Example City", "456 Another Street, Another City"], "city": "Example City", "coordinates": [[37.7749, -122.4194], [48.8566, 2.3522]], "is_in_mlm": 1, "is_incognito": false, "wallet_number": "0x27b0B8cfa07fA72f36Ad953F679D36EBC7d4355", "language": null}, "wallet_number": "0x27b0B8cfa07fA72f36Ad953F679D36EBC7d4355", "user_logo_url": "/user_logo/02adc6e0-3142-4d7b-b6b0-aca006ad7a43_96375f13-7391-4dad-949d-420a0069ceb1_\\u043c\\u043e\\u043b\\u0435\\u043a\\u0443\\u043b\\u0430_preview_rev_1.png"}'}
2025-03-11 20:38:09,581 - INFO - Получена задача для обработки: {'input_path': '/app/video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4', 'output_path': {'path': './output_video', 'status': 'exists'}, 'preview_path': {'path': './output_preview', 'status': 'exists'}, 'form_data': {'name': 'Кусок обоссонного гавна', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [[37.7749, -122.4194], [48.8566, 2.3522]], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x27b0B8cfa07fA72f36Ad953F679D36EBC7d4355', 'language': None}, 'wallet_number': '0x27b0B8cfa07fA72f36Ad953F679D36EBC7d4355', 'user_logo_url': '/user_logo/02adc6e0-3142-4d7b-b6b0-aca006ad7a43_96375f13-7391-4dad-949d-420a0069ceb1_молекула_preview_rev_1.png'}
2025-03-11 20:38:09,581 - INFO - Начинаю конвертацию видео /app/video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4 в VP9
2025-03-11 20:38:09,583 - INFO - Запуск конвертации видео в VP9: /app/video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4 -> ./77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_converted.webm
2025-03-11 20:38:31,623 - INFO - Конвертация в VP9 завершена: ./77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_converted.webm (Размер: 3.39 MB, Время: 22.04 сек.)
2025-03-11 20:38:31,624 - INFO - Видео успешно обработано: ./77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_converted.webm (Размер: 3.39 MB)
2025-03-11 20:38:31,624 - INFO - Путь к конвертированному видео: ./77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_converted.webm
2025-03-11 20:38:31,624 - INFO - Задача конвертации для /app/video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4 завершена успешно
2025-03-11 20:38:31,624 - INFO - Начинаю извлечение превью для /app/video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4
2025-03-11 20:38:31,624 - INFO - Извлечение превью из видео: /app/video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4 -> ./77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_preview.webm (Длительность: 5 сек.)
2025-03-11 20:38:39,490 - INFO - Извлечение превью завершено: ./77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_preview.webm (Размер: 1.27 MB, Время: 7.87 сек.)
2025-03-11 20:38:39,490 - INFO - Превью успешно извлечено: ./77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_preview.webm (Размер: 1.27 MB)
2025-03-11 20:38:39,490 - INFO - Путь к извлеченному превью: ./77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_preview.webm
2025-03-11 20:38:39,490 - INFO - Извлечение превью для /app/video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4 завершено успешно
2025-03-11 20:38:39,490 - INFO - Начинаю загрузку видео {'path': './output_video', 'status': 'exists'} и превью {'path': './output_preview', 'status': 'exists'} в S3
2025-03-11 20:38:40,024 - INFO - Соединение с AWS S3 установлено успешно.
2025-03-11 20:38:40,096 - INFO - Загрузка видео в AWS S3: ./77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_converted.webm -> 77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_converted.webm
2025-03-11 20:38:46,627 - INFO - Видео успешно загружено в AWS S3: 77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_converted.webm
2025-03-11 20:38:46,628 - INFO - Загрузка превью в AWS S3: ./77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_preview.webm -> 77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_preview.webm
2025-03-11 20:38:49,851 - INFO - Превью успешно загружено в AWS S3: 77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_preview.webm
2025-03-11 20:38:49,853 - INFO - Загруженные файлы: Видео - https://stt-market-videos.s3.eu-north-1.amazonaws.com/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_converted.webm, Превью - https://stt-market-videos.s3.eu-north-1.amazonaws.com/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_preview.webm
2025-03-11 20:38:49,856 - INFO - Загрузка видео {'path': './output_video', 'status': 'exists'} в S3 завершена успешно. URL: https://stt-market-videos.s3.eu-north-1.amazonaws.com/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_converted.webm
2025-03-11 20:38:49,856 - INFO - Загрузка превью {'path': './output_preview', 'status': 'exists'} в S3 завершена успешно. URL: https://stt-market-videos.s3.eu-north-1.amazonaws.com/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4_preview.webm
2025-03-11 20:38:49,857 - INFO - Начинаю сохранение профиля в БД для пользователя Кусок обоссонного гавна
2025-03-11 20:38:49,857 - INFO - Открытие сессии с БД...
2025-03-11 20:38:49,861 - INFO - Сессия с БД успешно открыта.
2025-03-11 20:38:50,003 - INFO - Обновлены данные профиля для кошелька 0x27b0B8cfa07fA72f36Ad953F679D36EBC7d4355
2025-03-11 20:38:50,046 - INFO - Хэштеги добавлены/обновлены для профиля пользователя 0x27b0B8cfa07fA72f36Ad953F679D36EBC7d4355
2025-03-11 20:38:50,056 - INFO - Видео, пользователь, логотип и хэштеги успешно сохранены для кошелька 0x27b0B8cfa07fA72f36Ad953F679D36EBC7d4355
2025-03-11 20:38:50,057 - INFO - Закрытие сессии с БД.
2025-03-11 20:38:50,057 - INFO - Профиль с именем Кусок обоссонного гавна успешно сохранен в БД
2025-03-11 20:38:50,057 - INFO - Весь цикл задач для /app/video_temp/77ecc4f8-eb62-4086-9362-d0562e6d43c1_100236-video-720.mp4 выполнен успешно!
2025-03-11 20:38:50,057 - INFO - Данные задачи очищены.
2025-03-11 20:40:13,730 - INFO - Открытие сессии с БД...
2025-03-11 20:40:13,739 - INFO - Сессия с БД успешно открыта.
2025-03-11 20:40:13,874 - INFO - Логи старше 10 минут и строки с неправильным форматом удалены из файла video_service.log.
2025-03-11 20:40:14,215 - INFO - Успешно обработано и закэшировано 914 профилей в Redis.
2025-03-11 20:40:14,258 - INFO - Всего публичных профилей в кеше: 492
2025-03-11 20:40:14,258 - INFO - Собрано уникальных профилей по алгоритму: 44
2025-03-11 20:40:14,259 - INFO - Добавляем 6 случайных профилей из оставшихся.
2025-03-11 20:40:14,259 - INFO - Сформировано страниц: 10
2025-03-11 20:40:14,261 - INFO - В кэше размещено 10 страниц.
2025-03-11 20:40:14,261 - INFO - Сформировано и закэшировано 10 страниц из 492 профилей.
2025-03-11 20:40:14,261 - INFO - Закрытие сессии с БД.
2025-03-11 20:41:02,140 - INFO - Получены данные профиля: {'name': 'Ебись все в рот!!!', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Gaming, Traveling', 'hashtags': None, 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'нахуй все', 'coordinates': [(59.77, 37.68)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x27b0B8cfa07fA72f36Ad953F679D36EBC7d4355', 'language': None}
2025-03-11 20:41:02,141 - INFO - Получены данные о изображении: {'image_path': './image_temp/96375f13-7391-4dad-949d-420a0069ceb1_молекула_preview_rev_1.png'}
2025-03-11 20:41:02,146 - INFO - Открытие сессии с БД...
2025-03-11 20:41:02,147 - INFO - Сессия с БД успешно открыта.
2025-03-11 20:41:02,166 - INFO - Обновлен профиль пользователя 941, is_admin сохранен: True
2025-03-11 20:41:02,196 - INFO - Профиль успешно обновлен.
2025-03-11 20:41:02,196 - INFO - Закрытие сессии с БД.
2025-03-11 20:43:13,717 - INFO - Открытие сессии с БД...
2025-03-11 20:43:13,720 - INFO - Сессия с БД успешно открыта.
2025-03-11 20:43:13,796 - INFO - Закрытие сессии с БД.
2025-03-11 20:43:13,797 - INFO - Данные о избранном и счетчике подписчиков успешно синхронизированы из кеша в базу данных для всех пользователей.
2025-03-11 20:43:50,541 - ERROR - Ошибка при получении сообщения: Connection closed by server.
Module: __main__, Function: main, Line: 168
