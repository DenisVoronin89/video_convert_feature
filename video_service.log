2025-04-12 13:36:30,529 - INFO - Redis доступен.
2025-04-12 13:36:30,530 - INFO - Проверка соединения с AWS S3...
2025-04-12 13:36:30,870 - INFO - Запуск приложения и инициализация базы данных...
2025-04-12 13:36:30,871 - DEBUG - Начало инициализации базы данных...
2025-04-12 13:36:31,086 - INFO - База данных успешно инициализирована.
2025-04-12 13:36:31,086 - INFO - Приложение успешно запущено. Соединение с базой данных установлено.
2025-04-12 13:36:31,086 - INFO - Директория уже существует: ./video_temp
2025-04-12 13:36:31,086 - INFO - Директория уже существует: ./image_temp
2025-04-12 13:36:31,086 - INFO - Директория уже существует: ./output_video
2025-04-12 13:36:31,086 - INFO - Директория уже существует: ./output_preview
2025-04-12 13:36:31,086 - INFO - Директория уже существует: ./user_logo
2025-04-12 13:36:31,086 - INFO - Директория уже существует: ./user_video_posters
2025-04-12 13:36:31,088 - INFO - Задача fetch_and_cache_profiles добавлена в расписание (каждые 5 минут).
2025-04-12 13:36:31,088 - INFO - Задача sync_data_to_db добавлена в расписание (каждые 5 минут).
2025-04-12 13:36:31,088 - INFO - Задача очистки логов добавлена в расписание (каждые 5 минут).
2025-04-12 13:36:31,088 - INFO - Задача очистки временных файлов добавлена в расписание (каждый день в 00:00).
2025-04-12 13:36:31,089 - INFO - Планировщик задач успешно запущен.
2025-04-12 13:36:31,488 - INFO - Соединение с AWS S3 установлено успешно.
2025-04-12 13:36:31,489 - INFO - Соединение с AWS S3 установлено успешно.
2025-04-12 13:36:31,489 - INFO - Подключаемся к Redis...
2025-04-12 13:36:31,490 - INFO - Подписались на канал video_tasks
2025-04-12 13:37:26,731 - INFO - Открытие сессии с БД...
2025-04-12 13:37:26,735 - INFO - Сессия с БД успешно открыта.
2025-04-12 13:37:26,753 - INFO - Поиск пользователя в базе данных.
2025-04-12 13:37:26,820 - INFO - Пользователь найден с ID 1
2025-04-12 13:37:26,890 - INFO - Получение избранного через get_favorites_from_cache.
2025-04-12 13:37:26,890 - INFO - Попытка получить избранное из кэша Redis для пользователя 1.
2025-04-12 13:37:26,908 - INFO - Избранное не найдено в кэше для пользователя 1. Загружаем из базы данных.
2025-04-12 13:37:26,908 - INFO - Открытие сессии с БД...
2025-04-12 13:37:26,908 - INFO - Сессия с БД успешно открыта.
2025-04-12 13:37:26,940 - INFO - У пользователя 1 нет избранных профилей.
2025-04-12 13:37:26,940 - INFO - Закрытие сессии с БД.
2025-04-12 13:37:26,940 - INFO - Избранное получено: []
2025-04-12 13:37:26,940 - INFO - Генерация токенов для пользователя.
2025-04-12 13:37:26,941 - INFO - Токены успешно сгенерированы.
2025-04-12 13:37:26,941 - INFO - Закрытие сессии с БД.
2025-04-12 13:37:53,479 - INFO - Получен запрос на загрузку видео от пользователя с ID: {current_user.user_id}
2025-04-12 13:37:53,529 - INFO - видео сохранено во временной директории: ./video_temp/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.mp4 (Размер: 3.20 MB)
2025-04-12 13:37:53,529 - INFO - Видео успешно загружено: ./video_temp/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.mp4
2025-04-12 13:38:55,560 - INFO - Получены данные профиля: {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#Diving', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'language': None}
2025-04-12 13:38:55,561 - INFO - Получены данные о изображении: {'image_path': '/user_logo/81a5be00-00f3-4811-9825-522ff0638343_4bad43da-ee9e-4a6d-a703-5f6683806bc8_c66f50f4ecb6aaf160ae3bd590effe68.jpg'}
2025-04-12 13:38:55,561 - INFO - Получены данные о видео: {'video_path': './video_temp/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.mp4'}
2025-04-12 13:38:55,561 - INFO - Путь к изображению: /user_logo/81a5be00-00f3-4811-9825-522ff0638343_4bad43da-ee9e-4a6d-a703-5f6683806bc8_c66f50f4ecb6aaf160ae3bd590effe68.jpg
2025-04-12 13:38:55,561 - INFO - Путь к видео: ./video_temp/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.mp4
2025-04-12 13:38:55,562 - INFO - Абсолютный путь к видео: /app/video_temp/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.mp4
2025-04-12 13:38:55,562 - INFO - Используется существующее изображение: /user_logo/81a5be00-00f3-4811-9825-522ff0638343_4bad43da-ee9e-4a6d-a703-5f6683806bc8_c66f50f4ecb6aaf160ae3bd590effe68.jpg
2025-04-12 13:38:55,562 - INFO - Обработка данных профиля...
2025-04-12 13:38:55,562 - INFO - Соединение с Redis для публикации задачи в канал установлено.
2025-04-12 13:38:55,562 - INFO - Публикуемые данные в Redis: {input_path: /app/video_temp/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.mp4, output_path: {'path': './output_video', 'status': 'exists'}, preview_path: {'path': './output_preview', 'status': 'exists'}, user_logo_url: /user_logo/81a5be00-00f3-4811-9825-522ff0638343_4bad43da-ee9e-4a6d-a703-5f6683806bc8_c66f50f4ecb6aaf160ae3bd590effe68.jpg, wallet_number: 0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545, form_data: {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#Diving', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'language': None}}
2025-04-12 13:38:55,570 - INFO - Задача успешно отправлена в канал video_tasks: {'input_path': '/app/video_temp/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.mp4', 'output_path': {'path': './output_video', 'status': 'exists'}, 'preview_path': {'path': './output_preview', 'status': 'exists'}, 'form_data': {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#Diving', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [(37.7749, -122.4194), (48.8566, 2.3522)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'language': None}, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'user_logo_url': '/user_logo/81a5be00-00f3-4811-9825-522ff0638343_4bad43da-ee9e-4a6d-a703-5f6683806bc8_c66f50f4ecb6aaf160ae3bd590effe68.jpg'}
2025-04-12 13:38:55,574 - INFO - Задача успешно отправлена в Redis.
2025-04-12 13:38:55,579 - INFO - Получено сообщение от Redis: {'type': 'message', 'pattern': None, 'channel': 'video_tasks', 'data': '{"input_path": "/app/video_temp/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.mp4", "output_path": {"path": "./output_video", "status": "exists"}, "preview_path": {"path": "./output_preview", "status": "exists"}, "form_data": {"name": "\\u041a\\u0443\\u0441\\u043e\\u043a \\u0441\\u0441\\u0430\\u043d\\u0438\\u043d\\u044b", "website_or_social": "https://twitter.com/johndoe", "activity_hobbies": "\\u0414\\u043e\\u043b\\u0431\\u0438\\u0442\\u044c\\u0441\\u044f \\u0432 \\u0441\\u0432\\u043e\\u0435 \\u043e\\u0447\\u043a\\u043e!", "hashtags": ["#gaming", "#Diving", "#travel", "#photography"], "adress": ["123 Example Street, Example City", "456 Another Street, Another City"], "city": "Example City", "coordinates": [[37.7749, -122.4194], [48.8566, 2.3522]], "is_in_mlm": 1, "is_incognito": false, "wallet_number": "0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545", "language": null}, "wallet_number": "0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545", "user_logo_url": "/user_logo/81a5be00-00f3-4811-9825-522ff0638343_4bad43da-ee9e-4a6d-a703-5f6683806bc8_c66f50f4ecb6aaf160ae3bd590effe68.jpg"}'}
2025-04-12 13:38:55,581 - INFO - Получена задача для обработки: {'input_path': '/app/video_temp/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.mp4', 'output_path': {'path': './output_video', 'status': 'exists'}, 'preview_path': {'path': './output_preview', 'status': 'exists'}, 'form_data': {'name': 'Кусок ссанины', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Долбиться в свое очко!', 'hashtags': ['#gaming', '#Diving', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'Example City', 'coordinates': [[37.7749, -122.4194], [48.8566, 2.3522]], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'language': None}, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'user_logo_url': '/user_logo/81a5be00-00f3-4811-9825-522ff0638343_4bad43da-ee9e-4a6d-a703-5f6683806bc8_c66f50f4ecb6aaf160ae3bd590effe68.jpg'}
2025-04-12 13:38:55,582 - INFO - Открытие сессии с БД...
2025-04-12 13:38:55,584 - INFO - Сессия с БД успешно открыта.
2025-04-12 13:38:55,689 - INFO - Статус профиля для 0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545 установлен в 'await'
2025-04-12 13:38:55,689 - INFO - Закрытие сессии с БД.
2025-04-12 13:38:55,690 - INFO - Конвертация видео: /app/video_temp/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.mp4
2025-04-12 13:38:55,690 - INFO - Начало конвертации: /app/video_temp/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.mp4 (размер: 3.20 MB)
2025-04-12 13:38:58,611 - INFO - Конвертация завершена за 2.92 сек | Размер: 2.62 MB | Коэффициент сжатия: 1.22x | Параметры: CRF=24, preset=fast
2025-04-12 13:38:58,612 - INFO - Видео сконвертировано: ./output_video/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.mp4
2025-04-12 13:38:58,613 - INFO - Генерация HLS плейлиста
2025-04-12 13:38:58,713 - INFO - HLS успешно сгенерирован: ./output_video/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat/hls/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.m3u8
2025-04-12 13:38:58,713 - INFO - HLS создан: ./output_video/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat/hls/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.m3u8
2025-04-12 13:38:58,713 - INFO - Извлечение постера из видео
2025-04-12 13:38:58,714 - INFO - Извлечение кадра из видео: ./output_video/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.mp4 -> user_video_posters/2189863f33f2450b9c6b1e5646003f4f.jpg (Время: 2 сек.)
2025-04-12 13:38:58,826 - INFO - Извлечение кадра завершено: user_video_posters/2189863f33f2450b9c6b1e5646003f4f.jpg (Время: 0.11 сек.)
2025-04-12 13:38:58,826 - INFO - Кадр успешно извлечён и сохранён: user_video_posters/2189863f33f2450b9c6b1e5646003f4f.jpg
2025-04-12 13:38:58,826 - INFO - Постер сохранен: user_video_posters/2189863f33f2450b9c6b1e5646003f4f.jpg
2025-04-12 13:38:58,826 - INFO - Загрузка файлов в S3
2025-04-12 13:39:06,296 - INFO - Соединение с AWS S3 установлено успешно.
2025-04-12 13:39:17,409 - INFO - Файлы загружены: https://stt-market-videos.s3.eu-north-1.amazonaws.com/videos/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat/341bfb16-81ff-4802-b5a3-e10fe0370f3c_cat_cat.mp4
2025-04-12 13:39:17,410 - INFO - Сохранение профиля в базе данных
2025-04-12 13:39:17,410 - INFO - Открытие сессии с БД...
2025-04-12 13:39:17,412 - INFO - Сессия с БД успешно открыта.
2025-04-12 13:39:17,412 - DEBUG - [LOG] Начало сохранения профиля для кошелька: 0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545
2025-04-12 13:39:17,414 - DEBUG - [LOG] Выполняется запрос пользователя по кошельку: 0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545
2025-04-12 13:39:17,441 - DEBUG - [LOG] Проверка существующего профиля пользователя ID 1
2025-04-12 13:39:17,463 - DEBUG - [LOG] Найден старый профиль, попытка удалить видео из облака
2025-04-12 13:39:17,464 - INFO - Начинаем удаление по префиксу: videos/1b4132d6-b80c-46c3-a271-ecf5a81c40f6_Futures_of_The_Past_111/
2025-04-12 13:39:17,523 - INFO - Запрашиваем объекты для префикса: videos/1b4132d6-b80c-46c3-a271-ecf5a81c40f6_Futures_of_The_Past_111/
2025-04-12 13:39:17,831 - INFO - Найдены объекты для удаления:
2025-04-12 13:39:18,549 - INFO - Успешно удалены:
2025-04-12 13:39:18,550 - INFO - Старые файлы удалены из облака для 0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545
2025-04-12 13:39:18,551 - DEBUG - [LOG] Получены координаты: [[37.7749, -122.4194], [48.8566, 2.3522]]
2025-04-12 13:39:18,566 - DEBUG - [LOG] Преобразованные координаты в WKT: MULTIPOINT (37.7749 -122.4194, 48.8566 2.3522)
2025-04-12 13:39:18,566 - DEBUG - [LOG] Профиль уже существует — выполняется обновление
2025-04-12 13:39:18,569 - DEBUG - [LOG] Старые логотип и постер: /user_logo/81a5be00-00f3-4811-9825-522ff0638343_4bad43da-ee9e-4a6d-a703-5f6683806bc8_c66f50f4ecb6aaf160ae3bd590effe68.jpg, user_video_posters/4a86306359c64a44b0e49afbad61184b.jpg
2025-04-12 13:39:18,570 - DEBUG - [LOG] Найдены изменения в медиафайлах, удаляем старые
2025-04-12 13:39:18,570 - DEBUG - Исходный путь постер: user_video_posters/4a86306359c64a44b0e49afbad61184b.jpg
2025-04-12 13:39:18,572 - INFO - Файл постер удалён с хоста: user_video_posters/4a86306359c64a44b0e49afbad61184b.jpg
2025-04-12 13:39:18,573 - INFO - Профиль обновлен, уникальная ссылка сохранена: 5ohr-uzac-n225-4e38
2025-04-12 13:39:18,573 - DEBUG - [LOG] Начинается синхронизация хэштегов для профиля ID 1
2025-04-12 13:39:18,589 - DEBUG - [LOG] Хэштеги из формы: {'photography', 'gaming', 'diving', 'travel'}
2025-04-12 13:39:18,598 - INFO - Хэштеги синхронизированы. Оставлено: 4
2025-04-12 13:39:18,599 - INFO - Данные успешно сохранены для кошелька 0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545
2025-04-12 13:39:18,600 - INFO - Закрытие сессии с БД.
2025-04-12 13:39:18,601 - INFO - Профиль успешно сохранен
2025-04-12 13:39:18,601 - INFO - Задача завершена, данные очищены
2025-04-12 13:39:31,111 - INFO - Открытие сессии с БД...
2025-04-12 13:39:31,116 - INFO - Сессия с БД успешно открыта.
2025-04-12 13:39:31,183 - INFO - Успешно обработано и закэшировано 1 профилей в Redis.
2025-04-12 13:39:31,184 - INFO - Собрано уникальных профилей по алгоритму: 1
2025-04-12 13:39:31,185 - INFO - Сформировано страниц: 1
2025-04-12 13:39:31,185 - INFO - В кэше размещено 1 страниц.
2025-04-12 13:39:31,185 - INFO - Сформировано и закэшировано 1 страниц из 1 профилей.
2025-04-12 13:39:31,185 - INFO - Закрытие сессии с БД.
2025-04-12 13:40:12,550 - INFO - Открытие сессии с БД...
2025-04-12 13:40:12,552 - INFO - Сессия с БД успешно открыта.
2025-04-12 13:40:12,556 - INFO - Поиск пользователя в базе данных.
2025-04-12 13:40:12,569 - INFO - Пользователь найден с ID 1
2025-04-12 13:40:12,579 - INFO - Получение избранного через get_favorites_from_cache.
2025-04-12 13:40:12,579 - INFO - Попытка получить избранное из кэша Redis для пользователя 1.
2025-04-12 13:40:12,584 - INFO - Избранное не найдено в кэше для пользователя 1. Загружаем из базы данных.
2025-04-12 13:40:12,585 - INFO - Открытие сессии с БД...
2025-04-12 13:40:12,585 - INFO - Сессия с БД успешно открыта.
2025-04-12 13:40:12,587 - INFO - У пользователя 1 нет избранных профилей.
2025-04-12 13:40:12,587 - INFO - Закрытие сессии с БД.
2025-04-12 13:40:12,588 - INFO - Избранное получено: []
2025-04-12 13:40:12,588 - INFO - Генерация токенов для пользователя.
2025-04-12 13:40:12,590 - INFO - Токены успешно сгенерированы.
2025-04-12 13:40:12,591 - INFO - Закрытие сессии с БД.
2025-04-12 13:41:17,588 - INFO - Получены данные профиля: {'name': 'Ебись все в рот!!!', 'website_or_social': 'https://twitter.com/johndoe', 'activity_hobbies': 'Gaming, Traveling', 'hashtags': ['#gaming', '#travel', '#photography'], 'adress': ['123 Example Street, Example City', '456 Another Street, Another City'], 'city': 'нахуй все', 'coordinates': [(59.77, 37.68)], 'is_in_mlm': 1, 'is_incognito': False, 'wallet_number': '0x39b0B8cfa77fA65f36Ad186F649D36EBC7d4545', 'language': None}
2025-04-12 13:41:17,597 - INFO - Получены данные о изображении: {'image_path': '/user_logo/81a5be00-00f3-4811-9825-522ff0638343_4bad43da-ee9e-4a6d-a703-5f6683806bc8_c66f50f4ecb6aaf160ae3bd590effe68.jpg'}
2025-04-12 13:41:17,598 - INFO - Используем мок-ссылки: video=https://stt-market-videos.s3.eu-north-1.amazonaws.com/videos/mock_video_3/hls/mock_video_3.m3u8, preview=https://stt-market-videos.s3.eu-north-1.amazonaws.com/videos/mock_video_3/hls/mock_video_3.m3u8, poster=https://stt-market-videos.s3.eu-north-1.amazonaws.com/videos/mock_video_3/mock_poster_3.jpg
2025-04-12 13:41:17,602 - INFO - Открытие сессии с БД...
2025-04-12 13:41:17,603 - INFO - Сессия с БД успешно открыта.
2025-04-12 13:41:17,624 - INFO - Обновлен профиль пользователя 1, user_link сохранен: 5ohr-uzac-n225-4e38
2025-04-12 13:41:17,638 - DEBUG - Удалена связь профиля с хэштегом: diving
2025-04-12 13:41:17,645 - INFO - Хэштеги обновлены. Актуальных хэштегов: 3
2025-04-12 13:41:17,648 - INFO - Профиль успешно обновлен.
2025-04-12 13:41:17,648 - INFO - Закрытие сессии с БД.
2025-04-12 13:41:31,133 - INFO - Логи старше 10 минут и строки с неправильным форматом удалены из файла video_service.log.
2025-04-12 13:41:32,619 - INFO - Открытие сессии с БД...
2025-04-12 13:41:32,620 - INFO - Сессия с БД успешно открыта.
2025-04-12 13:41:32,623 - INFO - Поиск пользователя в базе данных.
2025-04-12 13:41:32,637 - INFO - Пользователь найден с ID 1
2025-04-12 13:41:32,651 - INFO - Получение избранного через get_favorites_from_cache.
2025-04-12 13:41:32,651 - INFO - Попытка получить избранное из кэша Redis для пользователя 1.
2025-04-12 13:41:32,658 - INFO - Избранное не найдено в кэше для пользователя 1. Загружаем из базы данных.
2025-04-12 13:41:32,658 - INFO - Открытие сессии с БД...
2025-04-12 13:41:32,659 - INFO - Сессия с БД успешно открыта.
2025-04-12 13:41:32,667 - INFO - У пользователя 1 нет избранных профилей.
2025-04-12 13:41:32,668 - INFO - Закрытие сессии с БД.
2025-04-12 13:41:32,670 - INFO - Избранное получено: []
2025-04-12 13:41:32,670 - INFO - Генерация токенов для пользователя.
2025-04-12 13:41:32,672 - INFO - Токены успешно сгенерированы.
2025-04-12 13:41:32,673 - INFO - Закрытие сессии с БД.
2025-04-12 13:41:41,795 - ERROR - Ошибка при получении сообщения: Connection closed by server.
Module: __main__, Function: main, Line: 196
